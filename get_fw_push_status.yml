---
- name: Get Firewall Push Status
  hosts: "{{ workflow_target_host }}"
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ panorama_username }}"
      password: "{{ panorama_password }}"

    # Expected values: template_stack, device_group
    push_scope_type: "{{ push_scope_type | default('template_stack') }}"

    scope_cfg:
      template_stack:
        detail_bulk_cmd: "show template-stack"
        push_scope_keyword: "template-stack"
        md5_field: "template-md5sum"
        status_field: "template-status"
        result_container_key: "template-stack"
      device_group:
        detail_bulk_cmd: "show devicegroups"
        push_scope_keyword: "device-group"
        md5_field: "shared-policy-md5sum"
        status_field: "shared-policy-status"
        result_container_key: "devicegroups"

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Validate push scope type
      ansible.builtin.assert:
        that:
          - push_scope_type in ['template_stack', 'device_group']
        fail_msg: "Invalid push_scope_type='{{ push_scope_type }}'. Use template_stack or device_group."

    - name: Get bulk scope status (sync info + member devices)
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: "{{ scope_cfg[push_scope_type].detail_bulk_cmd }}"
      register: scope_detail_bulk_raw
      failed_when: false

    - name: Normalize bulk scope stdout into JSON variable
      ansible.builtin.set_fact:
        scope_stdout_json: >-
          {{
            (scope_detail_bulk_raw.stdout | from_json)
            if (scope_detail_bulk_raw.stdout is string)
            else (scope_detail_bulk_raw.stdout | default({}))
          }}

    - name: Normalize scope entries list from JSON
      ansible.builtin.set_fact:
        scope_entries: >-
          {{
            [scope_entries_raw]
            if (scope_entries_raw is mapping)
            else (scope_entries_raw | default([]))
          }}
      vars:
        scope_entries_raw: "{{ scope_stdout_json.response.result[scope_cfg[push_scope_type].result_container_key].entry | default([]) }}"

    - name: Parse candidate scope names from JSON
      ansible.builtin.set_fact:
        candidate_scope_names: >-
          {%- set names = [] -%}
          {%- for scope in scope_entries -%}
          {%-   set name = (scope.get('name', scope.get('@name', '')) | string | trim) -%}
          {%-   if name != '' -%}
          {%-     set _ = names.append(name) -%}
          {%-   endif -%}
          {%- endfor -%}
          {{ names | unique | sort | list }}

    - name: Build all scope device records from JSON
      ansible.builtin.set_fact:
        all_scope_device_records: >-
          {%- set records = [] -%}
          {%- for scope in scope_entries -%}
          {%-   set scope_name = (scope.get('name', scope.get('@name', '')) | string | trim) -%}
          {%-   set devices_raw = ((scope.devices.entry) if (scope.devices is defined and scope.devices.entry is defined) else []) -%}
          {%-   set devices = ([devices_raw] if (devices_raw is mapping) else (devices_raw | default([]))) -%}
          {%-   for dev in devices -%}
          {%-     set sync_status = (dev.get(scope_cfg[push_scope_type].status_field, '') | string | lower | trim) -%}
          {%-     set _ = records.append(
                    {
                      'scope': scope_name,
                      'serial': (dev.get('serial', '') | string | trim),
                      'hostname': (dev.get('hostname', '') | string | trim),
                      'connected': (dev.get('connected', '') | string | lower | trim),
                      'md5': (dev.get(scope_cfg[push_scope_type].md5_field, '') | string | trim),
                      'sync_status': sync_status,
                      'has_out_of_sync': (sync_status == 'out of sync'),
                      'has_in_sync': (sync_status == 'in sync')
                    }
                  ) -%}
          {%-   endfor -%}
          {%- endfor -%}
          {{ records }}

    - name: Parse connected and disconnected device lists from scope data
      ansible.builtin.set_fact:
        connected_device_serials: >-
          {{
            all_scope_device_records
            | selectattr('connected', 'in', ['yes', 'true', '1'])
            | map(attribute='serial')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}
        disconnected_device_serials: >-
          {{
            all_scope_device_records
            | rejectattr('connected', 'in', ['yes', 'true', '1'])
            | map(attribute='serial')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}

    - name: Debug base parsing
      ansible.builtin.debug:
        msg:
          push_scope_type: "{{ push_scope_type }}"
          scope_count: "{{ candidate_scope_names | length }}"
          scope_names: "{{ candidate_scope_names }}"
          all_scope_device_count: "{{ all_scope_device_records | length }}"
          connected_device_count: "{{ connected_device_serials | length }}"
          disconnected_device_count: "{{ disconnected_device_serials | length }}"

    - name: Initialize scope classification variables
      ansible.builtin.set_fact:
        scopes_with_connected_devices: []
        scopes_with_no_connected_devices: []
        scopes_in_sync: []
        scopes_out_of_sync: []
        scope_sync_details: {}

    - name: Classify scope connectivity and sync state
      ansible.builtin.set_fact:
        scopes_with_connected_devices: >-
          {{
            (
              scopes_with_connected_devices
              + ([item] if (scope_connected_devices | length > 0) else [])
            )
            | unique
            | list
          }}
        scopes_with_no_connected_devices: >-
          {{
            (
              scopes_with_no_connected_devices
              + ([item] if (scope_connected_devices | length == 0) else [])
            )
            | unique
            | list
          }}
        scopes_in_sync: >-
          {{
            (
              scopes_in_sync
              + ([item] if ((scope_connected_devices | length > 0) and (scope_connected_out_of_sync_records | length == 0) and (scope_connected_in_sync_records | length > 0)) else [])
            )
            | unique
            | list
          }}
        scopes_out_of_sync: >-
          {{
            (
              scopes_out_of_sync
              + ([item] if ((scope_connected_devices | length > 0) and (scope_connected_out_of_sync_records | length > 0)) else [])
            )
            | unique
            | list
          }}
        scope_sync_details: >-
          {{
            scope_sync_details
            | combine(
                {
                  item: {
                    'devices_in_scope': scope_devices_in_scope,
                    'device_hostnames_in_scope': scope_device_hostnames,
                    'connected_devices_in_scope': scope_connected_devices,
                    'connected_device_hostnames_in_scope': scope_connected_hostnames,
                    'md5_values_found': scope_md5_values | unique,
                    'connected_in_sync_count': (scope_connected_in_sync_records | length),
                    'connected_out_of_sync_count': (scope_connected_out_of_sync_records | length),
                    'is_connected': (scope_connected_devices | length > 0),
                    'is_in_sync': ((scope_connected_devices | length > 0) and (scope_connected_out_of_sync_records | length == 0) and (scope_connected_in_sync_records | length > 0)),
                    'is_out_of_sync': ((scope_connected_devices | length > 0) and (scope_connected_out_of_sync_records | length > 0))
                  }
                },
                recursive=True
              )
          }}
      vars:
        scope_records: "{{ all_scope_device_records | selectattr('scope', 'equalto', item) | list }}"
        scope_devices_in_scope: >-
          {{
            scope_records
            | map(attribute='serial')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}
        scope_device_hostnames: >-
          {{
            scope_records
            | map(attribute='hostname')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}
        scope_connected_records: "{{ scope_records | selectattr('connected', 'in', ['yes', 'true', '1']) | list }}"
        scope_connected_in_sync_records: "{{ scope_connected_records | selectattr('has_in_sync', 'equalto', true) | list }}"
        scope_connected_out_of_sync_records: "{{ scope_connected_records | selectattr('has_out_of_sync', 'equalto', true) | list }}"
        scope_connected_devices: >-
          {{
            scope_connected_records
            | map(attribute='serial')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}
        scope_connected_hostnames: >-
          {{
            scope_connected_records
            | map(attribute='hostname')
            | reject('equalto', '')
            | unique
            | sort
            | list
          }}
        scope_md5_values: >-
          {{
            scope_records
            | map(attribute='md5')
            | reject('equalto', '')
            | unique
            | list
          }}
      loop: "{{ candidate_scope_names }}"
      loop_control:
        label: "{{ item }}"

    - name: Debug scope connectivity and sync buckets
      ansible.builtin.debug:
        msg:
          scopes_with_connected_devices: "{{ scopes_with_connected_devices }}"
          scopes_with_no_connected_devices: "{{ scopes_with_no_connected_devices }}"
          scopes_in_sync: "{{ scopes_in_sync }}"
          scopes_out_of_sync: "{{ scopes_out_of_sync }}"
          scope_sync_details: "{{ scope_sync_details }}"

    - name: Build push-scope list argument
      ansible.builtin.set_fact:
        out_of_sync_scope_items_sanitized: >-
          {{
            scopes_out_of_sync
            | map('replace', '\n', ' ')
            | map('replace', '\r', ' ')
            | map('replace', '\t', ' ')
            | map('trim')
            | map('replace', '"', '')
            | map('replace', '[', '')
            | map('replace', ']', '')
            | map('trim')
            | reject('equalto', '')
            | list
          }}

    - name: Build push-scope bracket argument
      ansible.builtin.set_fact:
        out_of_sync_scope_arg: "[{{ out_of_sync_scope_items_sanitized | join(' ') }}]"

    - name: Build push-scope XML members argument
      ansible.builtin.set_fact:
        out_of_sync_scope_members_xml: >-
          {%- set members = [] -%}
          {%- for scope_name in out_of_sync_scope_items_sanitized -%}
          {%-   set _ = members.append('<member>' ~ scope_name ~ '</member>') -%}
          {%- endfor -%}
          {{ members | join('') }}

    - name: Build push-scope XML command strings
      ansible.builtin.set_fact:
        push_scope_cmd_xml_current: >-
          <show><config><push-scope><{{ scope_cfg[push_scope_type].push_scope_keyword }}>{{ out_of_sync_scope_members_xml }}</{{ scope_cfg[push_scope_type].push_scope_keyword }}></push-scope></config></show>
        push_scope_cmd_xml_pushed_changes_yes: >-
          <show><config><push-scope><{{ scope_cfg[push_scope_type].push_scope_keyword }}>{{ out_of_sync_scope_members_xml }}</{{ scope_cfg[push_scope_type].push_scope_keyword }}><pushed-changes>yes</pushed-changes></push-scope></config></show>

    - name: Debug push-scope command strings
      ansible.builtin.debug:
        msg:
          out_of_sync_scope_items_sanitized: "{{ out_of_sync_scope_items_sanitized }}"
          push_scope_cmd_current: "show config push-scope {{ scope_cfg[push_scope_type].push_scope_keyword }} {{ out_of_sync_scope_arg }}"
          push_scope_cmd_pushed_changes_yes: "show config push-scope {{ scope_cfg[push_scope_type].push_scope_keyword }} {{ out_of_sync_scope_arg }} pushed-changes yes"
          push_scope_cmd_xml_current: "{{ push_scope_cmd_xml_current }}"
          push_scope_cmd_xml_pushed_changes_yes: "{{ push_scope_cmd_xml_pushed_changes_yes }}"
      when: scopes_out_of_sync | length > 0

    - name: Run show config push-scope for out-of-sync scopes (current)
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: "{{ push_scope_cmd_xml_current }}"
        cmd_is_xml: true
      register: push_scope_raw
      failed_when: false
      when: scopes_out_of_sync | length > 0

    - name: Run show config push-scope for out-of-sync scopes (pushed-changes yes)
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: "{{ push_scope_cmd_xml_pushed_changes_yes }}"
        cmd_is_xml: true
      register: push_scope_pushed_raw
      failed_when: false
      when: scopes_out_of_sync | length > 0

    - name: Initialize push scope change tracking
      ansible.builtin.set_fact:
        push_scope_changes_by_scope: {}
        push_scope_changes_summary: {}

    - name: Normalize push-scope responses to JSON
      ansible.builtin.set_fact:
        push_scope_current_json: >-
          {{
            (push_scope_raw.stdout | from_json)
            if (push_scope_raw.stdout is string)
            else (push_scope_raw.stdout | default({}))
          }}
        push_scope_pushed_json: >-
          {{
            (push_scope_pushed_raw.stdout | from_json)
            if (push_scope_pushed_raw.stdout is string)
            else (push_scope_pushed_raw.stdout | default({}))
          }}
      when: scopes_out_of_sync | length > 0

    - name: Normalize push-scope object entry lists
      ansible.builtin.set_fact:
        push_scope_current_entries: >-
          {{
            [current_entries_raw]
            if (current_entries_raw is mapping)
            else (current_entries_raw | default([]))
          }}
        push_scope_pushed_entries: >-
          {{
            [pushed_entries_raw]
            if (pushed_entries_raw is mapping)
            else (pushed_entries_raw | default([]))
          }}
      vars:
        current_entries_raw: "{{ push_scope_current_json.response.result.objects.entry | default([]) }}"
        pushed_entries_raw: "{{ push_scope_pushed_json.response.result.objects.entry | default([]) }}"
      when: scopes_out_of_sync | length > 0

    - name: Combine push-scope object entries before parsing
      ansible.builtin.set_fact:
        push_scope_combined_entries: "{{ (push_scope_current_entries | default([])) + (push_scope_pushed_entries | default([])) }}"
      when: scopes_out_of_sync | length > 0

    - name: Track xpaths, locations, admins, and object types for out-of-sync scopes
      ansible.builtin.set_fact:
        push_scope_changes_summary:
          entries: "{{ combined_entries_slim }}"
          all_unique_xpaths: "{{ combined_entries_slim | map(attribute='xpath') | reject('equalto', '') | unique | list }}"
          all_unique_locs: "{{ combined_entries_slim | map(attribute='loc') | reject('equalto', '') | unique | list }}"
          all_unique_owners: "{{ combined_entries_slim | map(attribute='admin') | reject('equalto', '') | unique | list }}"
          all_unique_objtypes: "{{ combined_entries_slim | map(attribute='objtype') | reject('equalto', '') | unique | list }}"
          owner_counts: "{{ owner_counts }}"
          loc_counts: "{{ loc_counts }}"
          objtype_counts: "{{ objtype_counts }}"
        push_scope_changes_by_scope: >-
          {%- set grouped = {} -%}
          {%- for scope_name in scopes_out_of_sync -%}
          {%-   set _ = grouped.update({scope_name: {'entries': [], 'xpaths': [], 'owners': [], 'objtypes': []}}) -%}
          {%- endfor -%}
          {%- for e in combined_entries_slim -%}
          {%-   set loc = e.loc | default('') -%}
          {%-   if loc in grouped -%}
          {%-     set _ = grouped[loc]['entries'].append(e) -%}
          {%-     if e.xpath not in grouped[loc]['xpaths'] and e.xpath != '' -%}{%- set _ = grouped[loc]['xpaths'].append(e.xpath) -%}{%- endif -%}
          {%-     if e.admin not in grouped[loc]['owners'] and e.admin != '' -%}{%- set _ = grouped[loc]['owners'].append(e.admin) -%}{%- endif -%}
          {%-     if e.objtype not in grouped[loc]['objtypes'] and e.objtype != '' -%}{%- set _ = grouped[loc]['objtypes'].append(e.objtype) -%}{%- endif -%}
          {%-   endif -%}
          {%- endfor -%}
          {{ grouped }}
      vars:
        combined_entries_slim: >-
          {%- set entries = [] -%}
          {%- for e in push_scope_combined_entries -%}
          {%-   set _ = entries.append({'xpath': (e.get('xpath', '') | string | trim), 'loc': (e.get('@loc', '') | string | trim), 'admin': (e.get('@admin', '') | string | trim), 'objtype': (e.get('@objtype', '') | string | trim)}) -%}
          {%- endfor -%}
          {{ entries }}
        owner_counts: >-
          {%- set counts = {} -%}
          {%- for e in combined_entries_slim -%}
          {%-   set key = e.admin | default('') -%}
          {%-   if key != '' -%}
          {%-     set _ = counts.update({key: ((counts.get(key, 0) | int) + 1)}) -%}
          {%-   endif -%}
          {%- endfor -%}
          {{ counts }}
        loc_counts: >-
          {%- set counts = {} -%}
          {%- for e in combined_entries_slim -%}
          {%-   set key = e.loc | default('') -%}
          {%-   if key != '' -%}
          {%-     set _ = counts.update({key: ((counts.get(key, 0) | int) + 1)}) -%}
          {%-   endif -%}
          {%- endfor -%}
          {{ counts }}
        objtype_counts: >-
          {%- set counts = {} -%}
          {%- for e in combined_entries_slim -%}
          {%-   set key = e.objtype | default('') -%}
          {%-   if key != '' -%}
          {%-     set _ = counts.update({key: ((counts.get(key, 0) | int) + 1)}) -%}
          {%-   endif -%}
          {%- endfor -%}
          {{ counts }}
      when: scopes_out_of_sync | length > 0

    - name: Ensure empty change tracking when no out-of-sync scopes
      ansible.builtin.set_fact:
        push_scope_changes_summary:
          entries: []
          all_unique_xpaths: []
          all_unique_locs: []
          all_unique_owners: []
          all_unique_objtypes: []
          owner_counts: {}
          account_counts: {}
          loc_counts: {}
          objtype_counts: {}
        push_scope_changes_by_scope: {}
      when: scopes_out_of_sync | length == 0

    - name: Final debug summary
      ansible.builtin.debug:
        msg:
          push_scope_changes_summary: "{{ push_scope_changes_summary }}"
          push_scope_type: "{{ push_scope_type }}"
          connected_scope_count: "{{ scopes_with_connected_devices | length }}"
          disconnected_scope_count: "{{ scopes_with_no_connected_devices | length }}"
          in_sync_scope_count: "{{ scopes_in_sync | length }}"
          out_of_sync_scope_count: "{{ scopes_out_of_sync | length }}"
          out_of_sync_scope_arg: "{{ out_of_sync_scope_arg | default('[]') }}"
          push_scope_changes_by_scope: "{{ push_scope_changes_by_scope }}"

    - name: Publish important outputs as stats
      ansible.builtin.set_stats:
        data:
          push_scope_type: "{{ push_scope_type }}"
          candidate_scope_names: "{{ candidate_scope_names }}"
          connected_device_serials: "{{ connected_device_serials }}"
          disconnected_device_serials: "{{ disconnected_device_serials }}"
          scopes_with_connected_devices: "{{ scopes_with_connected_devices }}"
          scopes_with_no_connected_devices: "{{ scopes_with_no_connected_devices }}"
          scopes_in_sync: "{{ scopes_in_sync }}"
          scopes_out_of_sync: "{{ scopes_out_of_sync }}"
          scope_sync_details: "{{ scope_sync_details }}"
          out_of_sync_scope_arg: "{{ out_of_sync_scope_arg | default('[]') }}"
          push_scope_changes_summary: "{{ push_scope_changes_summary }}"
          push_scope_changes_by_scope: "{{ push_scope_changes_by_scope }}"
